<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Portal</title>
  <!-- Tailwind CSS via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts - Inter -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-100 antialiased">

<!-- Main Application Container -->
<div id="app-container" class="min-h-screen p-8 flex items-center justify-center">

  <!-- Authentication Forms Section (Login & Register) -->
  <div id="auth-section" class="max-w-md w-full bg-white rounded-3xl shadow-xl overflow-hidden p-8">
    <div class="text-center">
      <h1 id="auth-title" class="text-3xl font-bold text-gray-800 mb-2">Welcome!</h1>
      <p class="text-gray-500 mb-6" id="auth-subtitle">Log in to view all available produce</p>
    </div>

    <!-- Message Box for Errors/Success -->
    <div id="message-box" class="hidden p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert"></div>

    <!-- Login Form -->
    <form id="login-form" class="space-y-4">
      <input type="email" id="login-email" placeholder="Email Address" required class="w-full px-4 py-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-green-500">
      <input type="password" id="login-password" placeholder="Password" required class="w-full px-4 py-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-green-500">
      <button type="submit" class="w-full px-6 py-3 rounded-full text-white font-semibold bg-green-500 hover:bg-green-600 transition-colors shadow-lg">Login</button>
    </form>

    <!-- Registration Form (initially hidden) -->
    <form id="register-form" class="space-y-4 hidden">
      <input type="email" id="register-email" placeholder="Email Address" required class="w-full px-4 py-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-green-500">
      <input type="password" id="register-password" placeholder="Password" required class="w-full px-4 py-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-green-500">
      <input type="password" id="confirm-password" placeholder="Confirm Password" required class="w-full px-4 py-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-green-500">
      <button type="submit" class="w-full px-6 py-3 rounded-full text-white font-semibold bg-green-500 hover:bg-green-600 transition-colors shadow-lg">Register</button>
    </form>

    <div class="text-center mt-6 text-gray-600">
      <p id="toggle-link">Don't have an account? <a href="#" class="text-green-500 hover:text-green-600 font-semibold">Register here</a></p>
    </div>
  </div>

  <!-- Dashboard Section (initially hidden) -->
  <div id="dashboard-section" class="max-w-4xl w-full bg-white rounded-3xl shadow-xl overflow-hidden p-6 hidden">
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-4xl font-bold text-gray-800">Available Produce</h1>
      <button id="sign-out-btn" class="px-4 py-2 rounded-full text-sm font-semibold text-white bg-red-500 hover:bg-red-600 transition-colors shadow-md">Sign Out</button>
    </div>

    <!-- User ID Display - Important for debugging -->
    <div class="mb-6 p-4 bg-blue-50 rounded-xl text-sm text-blue-700">
      <span class="font-semibold">User ID:</span> <span id="user-id"></span>
    </div>

    <!-- Produce List -->
    <h2 class="text-2xl font-semibold text-gray-700 mb-4">Market Inventory</h2>
    <div id="produce-list" class="space-y-4">
      <p class="text-center text-gray-500">Loading available produce...</p>
    </div>
  </div>

</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js"></script>

<!-- Your local firebase-config.js file -->
<script src="./firebase-config.js"></script>

<script type="module">
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
  import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

  // NOTE: This will be replaced by your local file in your own project.
  // This is a placeholder for this environment.
  const { firebaseConfig } = window;
  
  // --- Initialize Firebase ---
  if (!firebaseConfig) {
      document.getElementById('message-box').classList.remove('hidden');
      document.getElementById('message-box').textContent = "Firebase configuration is missing. Please create and link `firebase-config.js`.";
      throw new Error("firebaseConfig is not defined. Please create and link `firebase-config.js`.");
  }

  const app = firebase.initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- DOM Elements ---
  const authSection = document.getElementById('auth-section');
  const dashboardSection = document.getElementById('dashboard-section');
  const loginForm = document.getElementById('login-form');
  const registerForm = document.getElementById('register-form');
  const toggleLink = document.getElementById('toggle-link');
  const messageBox = document.getElementById('message-box');
  const authTitle = document.getElementById('auth-title');
  const authSubtitle = document.getElementById('auth-subtitle');
  const userIdDisplay = document.getElementById('user-id');
  const signOutBtn = document.getElementById('sign-out-btn');
  const produceList = document.getElementById('produce-list');
  
  // --- UI Functions ---
  const showMessage = (message, isError = true) => {
    messageBox.textContent = message;
    messageBox.classList.remove('hidden');
    messageBox.classList.remove(isError ? 'bg-green-100' : 'bg-red-100');
    messageBox.classList.remove(isError ? 'text-green-700' : 'text-red-700');
    messageBox.classList.add(isError ? 'bg-red-100' : 'bg-green-100');
    messageBox.classList.add(isError ? 'text-red-700' : 'text-green-700');
  };

  const clearForms = () => {
    loginForm.reset();
    registerForm.reset();
  };
  
  const showDashboard = (userId) => {
    authSection.classList.add('hidden');
    dashboardSection.classList.remove('hidden');
    userIdDisplay.textContent = userId;
  };

  const showAuth = () => {
    authSection.classList.remove('hidden');
    dashboardSection.classList.add('hidden');
    clearForms();
  };

  const renderProduceList = (items) => {
    produceList.innerHTML = ''; // Clear previous list
    if (items.length === 0) {
      produceList.innerHTML = '<p class="text-center text-gray-500">No produce is currently available.</p>';
      return;
    }

    items.forEach(item => {
      const li = document.createElement('li');
      li.className = 'bg-gray-50 p-6 rounded-2xl shadow-sm flex flex-col sm:flex-row justify-between items-center transition-transform hover:scale-105';
      li.innerHTML = `
        <div class="flex-1 min-w-0">
          <h3 class="text-xl font-semibold text-gray-800 truncate">${item.name}</h3>
          <p class="text-gray-600">Quantity: <span class="font-medium text-gray-800">${item.quantity}</span></p>
          <p class="text-gray-600">Price: <span class="font-medium text-gray-800">$${item.price.toFixed(2)}</span></p>
        </div>
        <div class="mt-4 sm:mt-0 flex space-x-2">
          <button class="px-4 py-2 rounded-full text-sm font-semibold text-white bg-blue-500 hover:bg-blue-600 transition-colors">Buy</button>
        </div>
      `;
      produceList.appendChild(li);
    });
  };

  // --- Auth Handlers ---
  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    try {
      await signInWithEmailAndPassword(auth, email, password);
      showMessage("Login successful!", false);
      clearForms();
    } catch (error) {
      console.error("Login error:", error);
      showMessage("Invalid email or password. Please try again.");
    }
  });

  registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    const confirmPassword = document.getElementById('confirm-password').value;
    
    if (password !== confirmPassword) {
      showMessage("Passwords do not match.");
      return;
    }
    if (password.length < 6) {
      showMessage("Password must be at least 6 characters long.");
      return;
    }

    try {
      await createUserWithEmailAndPassword(auth, email, password);
      showMessage("Registration successful! You are now logged in.", false);
      clearForms();
    } catch (error) {
      console.error("Registration error:", error);
      switch (error.code) {
        case 'auth/email-already-in-use':
          showMessage('This email is already registered. Please login or use a different email.');
          break;
        case 'auth/invalid-email':
          showMessage('The email address is not valid.');
          break;
        case 'auth/weak-password':
          showMessage('The password is too weak.');
          break;
        default:
          showMessage('An error occurred during registration. Please try again.');
      }
    }
  });

  signOutBtn.addEventListener('click', async () => {
    try {
      await signOut(auth);
      showMessage("Successfully signed out.", false);
    } catch (error) {
      console.error("Sign out error:", error);
      showMessage("Could not sign out. Please try again.");
    }
  });

  // --- Auth UI Toggle ---
  toggleLink.addEventListener('click', (e) => {
    e.preventDefault();
    if (loginForm.classList.contains('hidden')) {
      loginForm.classList.remove('hidden');
      registerForm.classList.add('hidden');
      authTitle.textContent = "Welcome!";
      authSubtitle.textContent = "Log in to view all available produce";
      toggleLink.innerHTML = "Don't have an account? <a href='#' class='text-green-500 hover:text-green-600 font-semibold'>Register here</a>";
    } else {
      loginForm.classList.add('hidden');
      registerForm.classList.remove('hidden');
      authTitle.textContent = "Create a Customer Account";
      authSubtitle.textContent = "Sign up to buy fresh, local produce";
      toggleLink.innerHTML = "Already have an account? <a href='#' class='text-green-500 hover:text-green-600 font-semibold'>Login here</a>";
    }
    messageBox.classList.add('hidden'); // Clear messages on toggle
  });

  // --- Real-time Data Listener ---
  onAuthStateChanged(auth, (user) => {
    if (user) {
      showDashboard(user.uid);
      const produceRef = collection(db, 'produce'); // Read from the public produce collection
      onSnapshot(produceRef, (snapshot) => {
        const items = [];
        snapshot.forEach(doc => {
          items.push({ id: doc.id, ...doc.data() });
        });
        renderProduceList(items);
      }, (error) => {
        console.error("Error fetching data:", error);
        showMessage("Error loading produce. Please try again.");
      });
    } else {
      showAuth();
      produceList.innerHTML = '<p class="text-center text-gray-500">Please log in to view available produce.</p>';
    }
  });
</script>

</body>
</html>
