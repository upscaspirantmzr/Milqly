<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KsheerFresh Admin Dashboard</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }
        .modal-content {
            background-color: #fff;
            margin: 15% auto; /* 15% from the top and centered */
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            width: 80%; /* Could be more or less, depending on screen size */
            max-width: 500px;
        }
        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-btn:hover,
        .close-btn:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4 sm:p-6">
    <!-- Main content container -->
    <div class="bg-white rounded-xl shadow-lg w-full max-w-7xl p-6 md:p-8 space-y-6">

        <!-- Header and User ID Display -->
        <header class="flex flex-col sm:flex-row justify-between items-center pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-bold text-gray-800">Admin Dashboard</h1>
            <div class="flex items-center space-x-4 mt-4 sm:mt-0">
                <span id="user-id" class="text-gray-500 text-sm md:text-base truncate max-w-[200px] sm:max-w-none">User ID: N/A</span>
                <button id="logout-btn" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-full hover:bg-red-600 transition duration-300 shadow-md">
                    <i class="fa-solid fa-right-from-bracket mr-2"></i>Logout
                </button>
            </div>
        </header>

        <!-- Loading and Status Messages -->
        <div id="status-container" class="flex justify-center items-center py-8">
            <div id="loading-spinner" class="hidden animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-blue-500"></div>
            <p id="status-message" class="text-lg text-gray-600 font-medium"></p>
        </div>

        <!-- Orders Table -->
        <div id="orders-table-container" class="overflow-x-auto rounded-lg shadow-md hidden">
            <table class="min-w-full bg-white divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Farmer ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Items</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                    </tr>
                </thead>
                <tbody id="orders-table-body" class="bg-white divide-y divide-gray-200">
                    <!-- Orders will be injected here by JavaScript -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- JavaScript for Firebase and page logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase configuration and app ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // Check for required configuration
        if (Object.keys(firebaseConfig).length === 0) {
            console.error("Firebase config is missing.");
            document.getElementById('status-message').textContent = 'Error: Firebase configuration is missing.';
            document.getElementById('loading-spinner').classList.add('hidden');
        }

        let app, db, auth;
        let unsubscribeOrders = null;
        let userId = null;

        const statusMessageEl = document.getElementById('status-message');
        const loadingSpinnerEl = document.getElementById('loading-spinner');
        const ordersTableContainerEl = document.getElementById('orders-table-container');
        const ordersTableBodyEl = document.getElementById('orders-table-body');
        const userIdEl = document.getElementById('user-id');

        /**
         * Initializes Firebase and sets up the authentication state listener.
         */
        const initFirebase = async () => {
            try {
                // Initialize Firebase app and services
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Sign in with the provided custom token if available
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                console.log("Firebase initialized and authentication attempted.");

                // Set up auth state change listener to handle user sessions
                onAuthStateChanged(auth, async (user) => {
                    loadingSpinnerEl.classList.add('hidden');
                    if (user) {
                        userId = user.uid;
                        userIdEl.textContent = `User ID: ${userId}`;
                        console.log("User is authenticated:", userId);

                        // Fetch user document to check for admin role
                        const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
                        const userDoc = await getDoc(userDocRef);
                        
                        if (userDoc.exists() && userDoc.data().role === 'admin') {
                            console.log("Admin role confirmed. Starting data fetch.");
                            statusMessageEl.textContent = '';
                            fetchOrders();
                        } else {
                            console.log("User is not an admin. Redirecting to login.");
                            statusMessageEl.textContent = 'Access Denied: You are not an administrator.';
                            ordersTableContainerEl.classList.add('hidden');
                            await signOut(auth);
                            setTimeout(() => window.location.href = 'index.html', 3000);
                        }
                    } else {
                        console.log("No user is signed in. Redirecting to login.");
                        statusMessageEl.textContent = 'Not authenticated. Redirecting...';
                        ordersTableContainerEl.classList.add('hidden');
                        setTimeout(() => window.location.href = 'index.html', 3000);
                    }
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                statusMessageEl.textContent = `Error: ${error.message}`;
                loadingSpinnerEl.classList.add('hidden');
            }
        };

        /**
         * Fetches and displays all orders from Firestore in real-time.
         */
        const fetchOrders = () => {
            if (unsubscribeOrders) {
                unsubscribeOrders(); // Unsubscribe from previous listener
            }

            // Get a reference to the 'orders' collection
            const ordersCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
            
            // Set up a real-time listener for the orders collection
            unsubscribeOrders = onSnapshot(ordersCollectionRef, (snapshot) => {
                const orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Fetched orders:", orders);

                // Check if any orders were found
                if (orders.length > 0) {
                    ordersTableContainerEl.classList.remove('hidden');
                    renderOrders(orders);
                } else {
                    statusMessageEl.textContent = 'No orders found.';
                    ordersTableContainerEl.classList.add('hidden');
                }
            }, (error) => {
                console.error("Error fetching orders:", error);
                statusMessageEl.textContent = 'Failed to load orders. Please try again.';
                ordersTableContainerEl.classList.add('hidden');
            });
        };

        /**
         * Renders the orders in the table.
         * @param {Array<Object>} orders - The list of order objects to render.
         */
        const renderOrders = (orders) => {
            ordersTableBodyEl.innerHTML = ''; // Clear existing table rows
            orders.forEach(order => {
                const row = document.createElement('tr');
                row.className = 'bg-white hover:bg-gray-50';

                // Format items for display
                const itemsList = order.items ? order.items.map(item => `${item.productName} (x${item.quantity})`).join('<br>') : 'N/A';
                
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${order.id}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate max-w-[150px]">${order.customerId || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate max-w-[150px]">${order.farmerId || 'Unassigned'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                        ${order.status === 'delivered' ? 'bg-green-100 text-green-800' :
                           order.status === 'out-for-delivery' ? 'bg-yellow-100 text-yellow-800' :
                           order.status === 'accepted' ? 'bg-blue-100 text-blue-800' :
                           'bg-red-100 text-red-800'}">
                           ${order.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <div class="max-h-20 overflow-y-auto">${itemsList}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(order.timestamp).toLocaleDateString()}</td>
                `;
                ordersTableBodyEl.appendChild(row);
            });
        };

        /**
         * Logs out the current user and redirects to the login page.
         */
        const handleLogout = async () => {
            try {
                await signOut(auth);
                console.log("User logged out successfully.");
                window.location.href = 'index.html'; // Redirect to main login page
            } catch (error) {
                console.error("Logout error:", error);
                alert("An error occurred during logout.");
            }
        };

        // Event listener for the logout button
        document.getElementById('logout-btn').addEventListener('click', handleLogout);

        // Start the application
        window.onload = () => {
            loadingSpinnerEl.classList.remove('hidden');
            statusMessageEl.textContent = 'Loading...';
            initFirebase();
        };

    </script>
</body>
</html>
