<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up / Login - KsheerFresh</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1f2937; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #34D399; border-radius: 10px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen justify-center items-center p-4">

    <!-- Auth Container -->
    <div class="bg-white p-8 md:p-12 rounded-3xl shadow-xl w-full max-w-md animate-fadeIn">
        <h2 id="auth-title" class="text-3xl font-bold text-center text-gray-800 mb-6">Sign Up</h2>
        <div id="auth-message-box" class="hidden mb-4 p-3 rounded-md text-sm text-center"></div>

        <form id="auth-form" class="space-y-4">
            <div>
                <input type="email" id="email" placeholder="Email Address" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200">
            </div>
            <div>
                <input type="password" id="password" placeholder="Password" required class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200">
            </div>
            <div>
                <select id="role" class="w-full px-4 py-3 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-200">
                    <option value="customer">Customer</option>
                    <option value="farmer">Farmer</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <button type="submit" id="auth-submit-btn" class="w-full bg-green-500 text-white font-bold py-3 rounded-xl hover:bg-green-600 transition duration-200">Sign Up</button>
        </form>
        <div class="mt-6 text-center">
            <button id="auth-google-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 transition duration-200 flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M23.954 12.297c0-.792-.066-1.576-.192-2.355H12.247v4.456h6.728c-.287 1.488-1.12 2.768-2.522 3.633v2.943h3.766c2.208-2.037 3.486-5.02 3.486-8.682z" fill="#4285F4"></path><path d="M12.247 23.99c2.923 0 5.378-.96 7.169-2.607l-3.766-2.943c-1.042.697-2.396 1.115-3.403 1.115-2.628 0-4.856-1.78-5.632-4.145H2.87v2.943c1.92 3.864 5.922 6.572 9.377 6.572z" fill="#34A853"></path><path d="M5.875 14.282c-.22-.697-.34-1.428-.34-2.185s.12-1.488.34-2.185V7.072H2.87c-.886 1.884-.94 4.07-.005 6.138L5.875 14.282z" fill="#FBBC05"></path><path d="M12.247 5.148c1.693 0 3.2.585 4.387 1.706l3.342-3.238C17.625 1.54 15.17.001 12.247.001 8.707.001 4.705 2.709 2.785 6.572l2.945 2.225c.776-2.365 3.004-4.149 5.632-4.149z" fill="#EA4335"></path></svg>
                Sign in with Google
            </button>
        </div>
        <p class="mt-4 text-center text-sm text-gray-500">
            <a href="#" id="auth-toggle-link" class="text-green-500 hover:text-green-600">Already have an account? Login</a>
        </p>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, getDocs, updateDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { firebaseConfig } from "./firebase-config.js";

        // --- Firebase Setup ---
        const appId = "ksheerfresh-portal"; // Use a consistent app ID
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (initialAuthToken) {
            signInWithCustomToken(auth, initialAuthToken).catch(error => console.error("Canvas Auth Error:", error));
        } else {
            signInAnonymously(auth).catch(error => console.error("Canvas Auth Error:", error));
        }

        // --- UI & Event Listeners ---
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const authSubmitBtn = document.getElementById('auth-submit-btn');
        const authGoogleBtn = document.getElementById('auth-google-btn');
        const authToggleLink = document.getElementById('auth-toggle-link');
        const authMessageBox = document.getElementById('auth-message-box');
        
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const roleSelect = document.getElementById('role');

        let isLoginMode = false;

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            authTitle.textContent = isLoginMode ? 'Login' : 'Sign Up';
            authSubmitBtn.textContent = isLoginMode ? 'Login' : 'Sign Up';
            authToggleLink.textContent = isLoginMode ? 'Need an account? Sign Up' : 'Already have an account? Login';
            roleSelect.classList.toggle('hidden', isLoginMode);
            showAuthMessage("", "");
        }

        function showAuthMessage(message, className) {
            authMessageBox.textContent = message;
            authMessageBox.className = `block mb-4 p-3 rounded-md text-sm text-center ${className}`;
        }

        authToggleLink.addEventListener('click', (e) => {
            e.preventDefault();
            toggleAuthMode();
        });

        // --- Authentication Logic ---
        async function handleAuth(e) {
            e.preventDefault();
            const email = emailInput.value;
            const password = passwordInput.value;

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    const role = roleSelect.value;
                    const userId = user.uid;
                    const userRef = doc(db, 'artifacts', appId, 'users', userId);

                    await setDoc(userRef, {
                        email: user.email,
                        role: role,
                        createdAt: new Date()
                    });
                }
                showAuthMessage("Success! Redirecting...", "bg-green-100 text-green-700");
            } catch (error) {
                console.error("Auth error:", error);
                let errorMessage = "An unknown error occurred.";
                switch(error.code) {
                    case 'auth/email-already-in-use': errorMessage = 'This email is already in use.'; break;
                    case 'auth/invalid-email': errorMessage = 'Invalid email address.'; break;
                    case 'auth/weak-password': errorMessage = 'Password should be at least 6 characters.'; break;
                    case 'auth/user-not-found': errorMessage = 'User not found.'; break;
                    case 'auth/wrong-password': errorMessage = 'Invalid password.'; break;
                    default: errorMessage = error.message; break;
                }
                showAuthMessage(errorMessage, "bg-red-100 text-red-700");
            }
        }

        async function handleGoogleSignIn() {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                const userId = user.uid;
                const userRef = doc(db, 'artifacts', appId, 'users', userId);

                const userSnap = await getDoc(userRef);
                if (!userSnap.exists()) {
                    await setDoc(userRef, {
                        email: user.email,
                        role: 'customer',
                        createdAt: new Date()
                    });
                }
                showAuthMessage("Google Sign-in successful. Redirecting...", "bg-green-100 text-green-700");
            } catch (error) {
                console.error("Google Sign-in error:", error);
                showAuthMessage("Google Sign-in failed. Please try again.", "bg-red-100 text-red-700");
            }
        }
        
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const userId = user.uid;
                const userRef = doc(db, 'artifacts', appId, 'users', userId);
                const userDoc = await getDoc(userRef);

                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const role = userData.role;

                    switch (role) {
                        case 'customer':
                            window.location.href = 'user-dashboard.html';
                            break;
                        case 'farmer':
                            window.location.href = 'farmer-dashboard.html';
                            break;
                        case 'admin':
                            window.location.href = 'admin-panel.html';
                            break;
                        default:
                            await signOut(auth);
                            break;
                    }
                }
            }
        });

        authForm.addEventListener('submit', handleAuth);
        authGoogleBtn.addEventListener('click', handleGoogleSignIn);

    </script>
</body>
</html>
