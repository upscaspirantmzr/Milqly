<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Milk Delivery - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 0;
            color: #1a202c;
        }
        .header {
            background-color: #ffffff;
            padding: 20px 40px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }
        .header-title {
            font-size: 1.5rem;
            font-weight: 700;
        }
        .header-user-info {
            display: flex;
            align-items: center;
            font-weight: 500;
            color: #4a5568;
        }
        .header-user-info span {
            margin-right: 15px;
        }
        .btn-logout {
            background-color: #e53e3e;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-logout:hover {
            background-color: #c53030;
            transform: translateY(-2px);
        }
        .main-content {
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .section-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 20px;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 10px;
        }
        .card {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            animation: fadeIn 0.8s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .card-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }
        .btn-add {
            background-color: #48bb78;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }
        .btn-add:hover {
            background-color: #38a169;
            transform: translateY(-2px);
        }
        .empty-state {
            text-align: center;
            color: #a0aec0;
            padding: 40px;
        }
        .subscription-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e2e8f0;
            padding: 15px 0;
        }
        .subscription-item:last-child {
            border-bottom: none;
        }
        .subscription-item-details {
            display: flex;
            flex-direction: column;
        }
        .subscription-item-details span:first-child {
            font-weight: 600;
            color: #2d3748;
        }
        .subscription-item-details span:last-child {
            font-size: 0.9rem;
            color: #718096;
        }
        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e2e8f0;
            padding: 15px 0;
        }
        .order-item:last-child {
            border-bottom: none;
        }
        .order-item-details {
            display: flex;
            flex-direction: column;
        }
        .order-item-status {
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 8px;
        }
        .status-delivered { background-color: #c6f6d5; color: #2f855a; }
        .status-pending { background-color: #f6e05e; color: #975a16; }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            animation: fadeInModal 0.3s ease-in-out;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 500px;
            animation: slideIn 0.5s ease-in-out;
        }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }
        .close-btn {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        .close-btn:hover, .close-btn:focus {
            color: #000;
            text-decoration: none;
        }
        .modal-form-group {
            margin-bottom: 15px;
        }
        .modal-form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .modal-form-group input, .modal-form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
        }
        #addSubscriptionBtn {
            width: 100%;
            padding: 12px;
            background-color: #48bb78;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        #addSubscriptionBtn:hover {
            background-color: #38a169;
        }
        
    </style>
</head>
<body>

    <div class="header">
        <div class="header-title">Milk Delivery</div>
        <div class="header-user-info">
            <span>Welcome, <span id="userName">User</span>!</span>
            <button class="btn-logout" id="logoutBtn">Logout</button>
        </div>
    </div>

    <div class="main-content">
        <h1 class="section-title">Dashboard</h1>

        <!-- My Subscriptions Section -->
        <div class="card">
            <div class="card-header">
                <h2>My Subscriptions</h2>
                <button class="btn-add" id="openSubscriptionModal">Add New Subscription</button>
            </div>
            <div id="subscriptionsList">
                <p class="empty-state" id="emptySubscriptions">No active subscriptions. Click "Add New Subscription" to get started!</p>
            </div>
        </div>

        <!-- My Orders Section (Dummy data for now, will be dynamic later) -->
        <div class="card">
            <div class="card-header">
                <h2>My Orders</h2>
            </div>
            <div id="ordersList">
                <p class="empty-state" id="emptyOrders">No orders placed yet.</p>
                <!-- Example of a single order item -->
                <div class="order-item" style="display: none;">
                    <div class="order-item-details">
                        <span>Order #12345</span>
                        <span>Quantity: 2 Litres</span>
                        <span>Date: 2024-05-22</span>
                    </div>
                    <span class="order-item-status status-delivered">Delivered</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Subscription Modal -->
    <div id="subscriptionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Subscription</h2>
                <span class="close-btn">&times;</span>
            </div>
            <form id="subscriptionForm">
                <div class="modal-form-group">
                    <label for="milkType">Milk Type</label>
                    <select id="milkType" required>
                        <option value="cow">Cow Milk</option>
                        <option value="buffalo">Buffalo Milk</option>
                        <option value="goat">Goat Milk</option>
                    </select>
                </div>
                <div class="modal-form-group">
                    <label for="quantity">Quantity (Litres)</label>
                    <input type="number" id="quantity" value="1" min="1" required>
                </div>
                <div class="modal-form-group">
                    <label for="deliveryFrequency">Delivery Frequency</label>
                    <select id="deliveryFrequency" required>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="bi-weekly">Bi-weekly</option>
                    </select>
                </div>
                <button type="submit" id="addSubscriptionBtn">Add Subscription</button>
            </form>
        </div>
    </div>

    <!-- Firebase configuration file -->
    <script src="firebase-config.js"></script>
    <script type="module">
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Initialize Firebase services
        const auth = getAuth();
        const db = getFirestore();

        const userNameElement = document.getElementById('userName');
        const logoutBtn = document.getElementById('logoutBtn');
        const openSubscriptionModalBtn = document.getElementById('openSubscriptionModal');
        const subscriptionModal = document.getElementById('subscriptionModal');
        const closeModalBtn = document.querySelector('.close-btn');
        const subscriptionForm = document.getElementById('subscriptionForm');
        const subscriptionsList = document.getElementById('subscriptionsList');
        const emptySubscriptions = document.getElementById('emptySubscriptions');

        // Check user authentication status
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                userNameElement.textContent = user.displayName || 'Customer';

                // Listen for user's subscriptions in real-time
                const subscriptionsRef = collection(db, "users", user.uid, "subscriptions");
                const q = query(subscriptionsRef);

                onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        emptySubscriptions.style.display = 'block';
                        subscriptionsList.innerHTML = `<p class="empty-state" id="emptySubscriptions">No active subscriptions. Click "Add New Subscription" to get started!</p>`;
                    } else {
                        emptySubscriptions.style.display = 'none';
                        subscriptionsList.innerHTML = '';
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            const subItem = document.createElement('div');
                            subItem.classList.add('subscription-item');
                            subItem.innerHTML = `
                                <div class="subscription-item-details">
                                    <span>${data.milkType.charAt(0).toUpperCase() + data.milkType.slice(1)} Milk - ${data.quantity} Litre(s)</span>
                                    <span>Frequency: ${data.deliveryFrequency}</span>
                                </div>
                                <button class="btn-logout btn-cancel-sub" data-id="${doc.id}">Cancel</button>
                            `;
                            subscriptionsList.appendChild(subItem);
                        });
                        // Add event listeners to newly created cancel buttons
                        document.querySelectorAll('.btn-cancel-sub').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                // For future development: implement cancellation logic
                                console.log("Cancel button clicked for subscription:", e.target.dataset.id);
                                alert("Cancellation functionality is coming soon!");
                            });
                        });
                    }
                });

            } else {
                // User is signed out, redirect to login page
                window.location.href = "customer-login.html";
            }
        });

        // Logout functionality
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                window.location.href = "customer-login.html";
            } catch (error) {
                console.error("Logout Error:", error);
                alert("An error occurred during logout. Please try again.");
            }
        });

        // Modal functionality
        openSubscriptionModalBtn.addEventListener('click', () => {
            subscriptionModal.style.display = 'block';
        });

        closeModalBtn.addEventListener('click', () => {
            subscriptionModal.style.display = 'none';
        });

        window.addEventListener('click', (event) => {
            if (event.target == subscriptionModal) {
                subscriptionModal.style.display = 'none';
            }
        });

        // Add new subscription to Firestore
        subscriptionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) {
                alert("Please log in to add a subscription.");
                return;
            }

            const milkType = document.getElementById('milkType').value;
            const quantity = parseInt(document.getElementById('quantity').value, 10);
            const deliveryFrequency = document.getElementById('deliveryFrequency').value;

            try {
                // Add a new document to the user's subscriptions sub-collection
                await addDoc(collection(db, "users", user.uid, "subscriptions"), {
                    milkType: milkType,
                    quantity: quantity,
                    deliveryFrequency: deliveryFrequency,
                    status: "active",
                    createdAt: new Date()
                });

                alert("Subscription added successfully!");
                subscriptionModal.style.display = 'none';
                subscriptionForm.reset();
            } catch (error) {
                console.error("Error adding subscription:", error);
                alert("An error occurred while adding the subscription. Please try again.");
            }
        });

    </script>
</body>
</html>
